name: Run Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Unit Tests Only (Exclude Integration)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --no-restore -c Release
      
    - name: Run unit tests only (exclude integration tests)
      id: test
      run: |
        echo "Running unit tests only - Integration tests excluded"
        echo "Test project: CrmClientApp.Tests"
        echo "Filter: Excluding tests with Category=Integration"
        dotnet test CrmClientApp.Tests/CrmClientApp.Tests.csproj --no-build -c Release --filter "Category!=Integration" --verbosity normal --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed" 2>&1 | tee test-output.txt
        echo "Test command completed with exit code: $?"
      continue-on-error: true
      
    - name: Extract test statistics
      id: stats
      if: always()
      run: |
        # Parse test results from TRX file using dotnet test output or TRX parsing
        # Try multiple patterns to extract statistics
        TOTAL=$(grep -iE "Total tests:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
        PASSED=$(grep -iE "Passed:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
        FAILED=$(grep -iE "Failed:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
        SKIPPED=$(grep -iE "Skipped:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
        
        # Alternative parsing from summary line
        if [ "$TOTAL" = "0" ]; then
          SUMMARY=$(grep -iE "Test Run (Successful|Failed)" test-output.txt || grep -iE "(\d+)\s+test\(s\)" test-output.txt | tail -1)
          if [ -n "$SUMMARY" ]; then
            TOTAL=$(echo "$SUMMARY" | grep -oE "\d+" | head -1 || echo "0")
          fi
        fi
        
        # Parse from TRX file if available
        if [ -f "**/test-results.trx" ] && [ "$TOTAL" = "0" ]; then
          TRX_FILE=$(find . -name "test-results.trx" | head -1)
          if [ -n "$TRX_FILE" ]; then
            TOTAL=$(grep -oE 'total="(\d+)"' "$TRX_FILE" | grep -oE '\d+' || echo "0")
            PASSED=$(grep -oE 'passed="(\d+)"' "$TRX_FILE" | grep -oE '\d+' || echo "0")
            FAILED=$(grep -oE 'failed="(\d+)"' "$TRX_FILE" | grep -oE '\d+' || echo "0")
            SKIPPED=$(grep -oE 'skipped="(\d+)"' "$TRX_FILE" | grep -oE '\d+' || echo "0")
          fi
        fi
        
        # Set defaults if still zero
        TOTAL=${TOTAL:-0}
        PASSED=${PASSED:-0}
        FAILED=${FAILED:-0}
        SKIPPED=${SKIPPED:-0}
        
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        
        echo "ðŸ“Š Test Statistics:"
        echo "  Total: $TOTAL"
        echo "  Passed: $PASSED"
        echo "  Failed: $FAILED"
        echo "  Skipped: $SKIPPED"
      
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: '**/test-results.trx'
        check_name: 'Unit Test Results'
        
    - name: Test Summary with Statistics
      if: always()
      run: |
        TOTAL="${{ steps.stats.outputs.total }}"
        PASSED="${{ steps.stats.outputs.passed }}"
        FAILED="${{ steps.stats.outputs.failed }}"
        SKIPPED="${{ steps.stats.outputs.skipped }}"
        
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… Passed | **$PASSED** |" >> $GITHUB_STEP_SUMMARY
        echo "| âŒ Failed | **$FAILED** |" >> $GITHUB_STEP_SUMMARY
        echo "| â­ï¸ Skipped | **$SKIPPED** |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ Total | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$FAILED" = "0" ] || [ -z "$FAILED" ]; then
          echo "âœ… **All unit tests passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **$FAILED test(s) failed**" >> $GITHUB_STEP_SUMMARY
        fi
