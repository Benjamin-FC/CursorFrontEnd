name: Run Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Unit Tests Only (Exclude Integration)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --no-restore -c Release
      
    - name: List test projects
      run: |
        echo "Checking for test projects..."
        dotnet sln list
        echo ""
        echo "Checking test project..."
        ls -la CrmClientApp.Tests/ || echo "Test project directory not found"
        
    - name: Run unit tests only (exclude integration tests)
      id: test
      run: |
        echo "Running unit tests only - Integration tests excluded"
        echo "Test project: CrmClientApp.Tests"
        echo "Filter: Excluding tests with Category=Integration"
        echo ""
        dotnet test CrmClientApp.Tests/CrmClientApp.Tests.csproj --no-build -c Release --filter "Category!=Integration" --verbosity normal --logger "trx;LogFileName=TestResults.trx" --logger "console;verbosity=normal" 2>&1 | tee test-output.txt
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        echo ""
        echo "Test command exit code: $TEST_EXIT_CODE"
        echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
      continue-on-error: true
      
    - name: Extract test statistics from TRX file
      id: stats
      if: always()
      run: |
        echo "=== Extracting test statistics ==="
        
        # Find TRX file
        TRX_FILE=$(find . -type f -name "TestResults.trx" -o -name "test-results.trx" -o -name "*.trx" | head -1)
        
        if [ -z "$TRX_FILE" ] || [ ! -f "$TRX_FILE" ]; then
          echo "âŒ TRX file not found. Searching..."
          find . -name "*.trx" -type f
          echo ""
          echo "Last 30 lines of test output for debugging:"
          tail -30 test-output.txt
          echo "0" > total.txt
          echo "0" > passed.txt
          echo "0" > failed.txt
          echo "0" > skipped.txt
        else
          echo "âœ… Found TRX file: $TRX_FILE"
          
          # Use xmllint or python to parse XML properly, fallback to grep
          if command -v xmllint &> /dev/null; then
            echo "Using xmllint to parse TRX file"
            TOTAL=$(xmllint --xpath "string(//Counters/@total)" "$TRX_FILE" 2>/dev/null || echo "0")
            PASSED=$(xmllint --xpath "string(//Counters/@passed)" "$TRX_FILE" 2>/dev/null || echo "0")
            FAILED=$(xmllint --xpath "string(//Counters/@failed)" "$TRX_FILE" 2>/dev/null || echo "0")
            EXECUTED=$(xmllint --xpath "string(//Counters/@executed)" "$TRX_FILE" 2>/dev/null || echo "0")
            SKIPPED=$(xmllint --xpath "string(//Counters/@notExecuted)" "$TRX_FILE" 2>/dev/null || echo "0")
          elif command -v python3 &> /dev/null; then
            echo "Using python to parse TRX file"
            python3 << 'PYTHON_SCRIPT'
import xml.etree.ElementTree as ET
import sys
try:
    tree = ET.parse('$TRX_FILE')
    root = tree.getroot()
    ns = {'': 'http://microsoft.com/schemas/VisualStudio/TeamTest/2010'}
    counters = root.find('.//Counters', ns)
    if counters is not None:
        total = counters.get('total', '0')
        passed = counters.get('passed', '0')
        failed = counters.get('failed', '0')
        executed = counters.get('executed', '0')
        skipped = counters.get('notExecuted', '0')
        print(f"TOTAL={total}")
        print(f"PASSED={passed}")
        print(f"FAILED={failed}")
        print(f"EXECUTED={executed}")
        print(f"SKIPPED={skipped}")
    else:
        print("TOTAL=0")
        print("PASSED=0")
        print("FAILED=0")
        print("EXECUTED=0")
        print("SKIPPED=0")
except Exception as e:
    print(f"TOTAL=0", file=sys.stderr)
    print(f"PASSED=0", file=sys.stderr)
    print(f"FAILED=0", file=sys.stderr)
    print(f"EXECUTED=0", file=sys.stderr)
    print(f"SKIPPED=0", file=sys.stderr)
PYTHON_SCRIPT
            # Parse python output
            PYTHON_OUTPUT=$(python3 << 'PYTHON_SCRIPT'
import xml.etree.ElementTree as ET
import sys
try:
    tree = ET.parse('$TRX_FILE')
    root = tree.getroot()
    ns = {'': 'http://microsoft.com/schemas/VisualStudio/TeamTest/2010'}
    counters = root.find('.//Counters', ns)
    if counters is not None:
        print(f"{counters.get('total', '0')} {counters.get('passed', '0')} {counters.get('failed', '0')} {counters.get('executed', '0')} {counters.get('notExecuted', '0')}")
    else:
        print("0 0 0 0 0")
except:
    print("0 0 0 0 0")
PYTHON_SCRIPT
            )
            TOTAL=$(echo "$PYTHON_OUTPUT" | awk '{print $1}')
            PASSED=$(echo "$PYTHON_OUTPUT" | awk '{print $2}')
            FAILED=$(echo "$PYTHON_OUTPUT" | awk '{print $3}')
            EXECUTED=$(echo "$PYTHON_OUTPUT" | awk '{print $4}')
            SKIPPED=$(echo "$PYTHON_OUTPUT" | awk '{print $5}')
          else
            echo "Using grep to parse TRX file (fallback)"
            # Fallback: grep for Counters element
            TOTAL=$(grep -oP 'total="\K\d+' "$TRX_FILE" | head -1 || echo "0")
            PASSED=$(grep -oP 'passed="\K\d+' "$TRX_FILE" | head -1 || echo "0")
            FAILED=$(grep -oP 'failed="\K\d+' "$TRX_FILE" | head -1 || echo "0")
            EXECUTED=$(grep -oP 'executed="\K\d+' "$TRX_FILE" | head -1 || echo "0")
            SKIPPED=$(grep -oP 'notExecuted="\K\d+' "$TRX_FILE" | head -1 || echo "0")
          fi
          
          # Use executed if total is 0
          if [ "$TOTAL" = "0" ] && [ "$EXECUTED" != "0" ]; then
            TOTAL=$EXECUTED
          fi
          
          echo "Parsed from TRX:"
          echo "  Total: $TOTAL"
          echo "  Passed: $PASSED"
          echo "  Failed: $FAILED"
          echo "  Executed: $EXECUTED"
          echo "  Skipped: $SKIPPED"
        fi
        
        # Fallback to console output if TRX parsing failed
        if [ "$TOTAL" = "0" ] || [ -z "$TOTAL" ]; then
          echo ""
          echo "âš ï¸ TRX parsing returned 0, trying console output..."
          # Look for summary line in console output
          SUMMARY=$(grep -iE "Test Run (Successful|Failed).*Total tests?:\s*\d+" test-output.txt | tail -1)
          if [ -n "$SUMMARY" ]; then
            TOTAL=$(echo "$SUMMARY" | grep -oP "Total tests?:\s*\K\d+" | head -1 || echo "0")
            PASSED=$(echo "$SUMMARY" | grep -oP "Passed:\s*\K\d+" | head -1 || echo "0")
            FAILED=$(echo "$SUMMARY" | grep -oP "Failed:\s*\K\d+" | head -1 || echo "0")
            echo "Parsed from console summary: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED"
          fi
        fi
        
        # Ensure we have valid numbers
        TOTAL=${TOTAL:-0}
        PASSED=${PASSED:-0}
        FAILED=${FAILED:-0}
        SKIPPED=${SKIPPED:-0}
        
        # Output for GitHub Actions
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸ“Š Final Test Statistics:"
        echo "  Total: $TOTAL"
        echo "  Passed: $PASSED"
        echo "  Failed: $FAILED"
        echo "  Skipped: $SKIPPED"
      
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: '**/test-results.trx'
        check_name: 'Unit Test Results'
        
    - name: Test Summary with Statistics
      if: always()
      run: |
        TOTAL="${{ steps.stats.outputs.total }}"
        PASSED="${{ steps.stats.outputs.passed }}"
        FAILED="${{ steps.stats.outputs.failed }}"
        SKIPPED="${{ steps.stats.outputs.skipped }}"
        
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… Passed | **$PASSED** |" >> $GITHUB_STEP_SUMMARY
        echo "| âŒ Failed | **$FAILED** |" >> $GITHUB_STEP_SUMMARY
        echo "| â­ï¸ Skipped | **$SKIPPED** |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ Total | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$FAILED" = "0" ] || [ -z "$FAILED" ]; then
          echo "âœ… **All unit tests passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **$FAILED test(s) failed**" >> $GITHUB_STEP_SUMMARY
        fi
