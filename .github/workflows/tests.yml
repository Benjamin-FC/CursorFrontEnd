name: Run Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Unit Tests Only (Exclude Integration)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --no-restore -c Release
      
    - name: List test projects
      run: |
        echo "Checking for test projects..."
        dotnet sln list
        echo ""
        echo "Checking test project..."
        ls -la CrmClientApp.Tests/ || echo "Test project directory not found"
        
    - name: Run unit tests only (exclude integration tests)
      id: test
      run: |
        echo "Running unit tests only - Integration tests excluded"
        echo "Test project: CrmClientApp.Tests"
        echo "Filter: Excluding tests with Category=Integration"
        echo ""
        echo "Running: dotnet test CrmClientApp.Tests/CrmClientApp.Tests.csproj --filter 'Category!=Integration'"
        dotnet test CrmClientApp.Tests/CrmClientApp.Tests.csproj --no-build -c Release --filter "Category!=Integration" --verbosity normal --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed" 2>&1 | tee test-output.txt
        echo ""
        echo "Test command completed with exit code: $?"
      continue-on-error: true
      
    - name: Extract test statistics
      id: stats
      if: always()
      run: |
        echo "=== Parsing test statistics ==="
        echo "Checking test output file..."
        ls -la test-output.txt || echo "test-output.txt not found"
        echo ""
        echo "Last 50 lines of test output:"
        tail -50 test-output.txt || echo "Could not read test output"
        echo ""
        
        # Try to find TRX file first (most reliable)
        TRX_FILE=$(find . -name "test-results.trx" -o -name "*.trx" | head -1)
        if [ -n "$TRX_FILE" ] && [ -f "$TRX_FILE" ]; then
          echo "Found TRX file: $TRX_FILE"
          # Parse from TRX XML file
          TOTAL=$(grep -oE 'tests="(\d+)"' "$TRX_FILE" | grep -oE '\d+' | head -1 || echo "0")
          PASSED=$(grep -oE 'passed="(\d+)"' "$TRX_FILE" | grep -oE '\d+' | head -1 || echo "0")
          FAILED=$(grep -oE 'failed="(\d+)"' "$TRX_FILE" | grep -oE '\d+' | head -1 || echo "0")
          EXECUTED=$(grep -oE 'executed="(\d+)"' "$TRX_FILE" | grep -oE '\d+' | head -1 || echo "0")
          
          # If executed is set but total is not, use executed
          if [ "$TOTAL" = "0" ] && [ "$EXECUTED" != "0" ]; then
            TOTAL=$EXECUTED
          fi
          
          echo "Parsed from TRX: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED"
        fi
        
        # If TRX parsing didn't work, try console output patterns
        if [ "$TOTAL" = "0" ] || [ -z "$TOTAL" ]; then
          echo "Parsing from console output..."
          
          # Pattern 1: "Total tests: X"
          TOTAL=$(grep -iE "Total tests?:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
          
          # Pattern 2: "Passed! - Failed: X, Passed: Y"
          if [ "$PASSED" = "0" ] || [ -z "$PASSED" ]; then
            PASSED=$(grep -iE "Passed!?\s*-\s+Failed:\s+\d+,\s+Passed:\s+(\d+)" test-output.txt | grep -oE "\d+" | tail -1 || echo "0")
          fi
          
          # Pattern 3: "Passed: X"
          if [ "$PASSED" = "0" ] || [ -z "$PASSED" ]; then
            PASSED=$(grep -iE "Passed:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
          fi
          
          # Pattern 4: "Failed: X"
          if [ "$FAILED" = "0" ] || [ -z "$FAILED" ]; then
            FAILED=$(grep -iE "Failed:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
          fi
          
          # Pattern 5: "Skipped: X"
          SKIPPED=$(grep -iE "Skipped:\s*(\d+)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
          
          # Pattern 6: Summary line like "Test Run Successful. Total tests: X, Passed: Y, Failed: Z"
          if [ "$TOTAL" = "0" ]; then
            SUMMARY_LINE=$(grep -iE "Test Run.*Total tests?:\s*(\d+)" test-output.txt | tail -1)
            if [ -n "$SUMMARY_LINE" ]; then
              TOTAL=$(echo "$SUMMARY_LINE" | grep -oE "Total tests?:\s*(\d+)" | grep -oE "\d+" | head -1 || echo "0")
              PASSED=$(echo "$SUMMARY_LINE" | grep -oE "Passed:\s*(\d+)" | grep -oE "\d+" | head -1 || echo "0")
              FAILED=$(echo "$SUMMARY_LINE" | grep -oE "Failed:\s*(\d+)" | grep -oE "\d+" | head -1 || echo "0")
            fi
          fi
          
          # Pattern 7: X test(s) format
          if [ "$TOTAL" = "0" ]; then
            TOTAL=$(grep -iE "(\d+)\s+test\(s\)" test-output.txt | grep -oE "\d+" | head -1 || echo "0")
          fi
          
          echo "Parsed from console: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED"
        fi
        
        # Calculate total if we have passed and failed
        if [ "$TOTAL" = "0" ] && [ "$PASSED" != "0" ] || [ "$FAILED" != "0" ]; then
          TOTAL=$((PASSED + FAILED + SKIPPED))
        fi
        
        # Set defaults
        TOTAL=${TOTAL:-0}
        PASSED=${PASSED:-0}
        FAILED=${FAILED:-0}
        SKIPPED=${SKIPPED:-0}
        
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸ“Š Final Test Statistics:"
        echo "  Total: $TOTAL"
        echo "  Passed: $PASSED"
        echo "  Failed: $FAILED"
        echo "  Skipped: $SKIPPED"
      
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: '**/test-results.trx'
        check_name: 'Unit Test Results'
        
    - name: Test Summary with Statistics
      if: always()
      run: |
        TOTAL="${{ steps.stats.outputs.total }}"
        PASSED="${{ steps.stats.outputs.passed }}"
        FAILED="${{ steps.stats.outputs.failed }}"
        SKIPPED="${{ steps.stats.outputs.skipped }}"
        
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… Passed | **$PASSED** |" >> $GITHUB_STEP_SUMMARY
        echo "| âŒ Failed | **$FAILED** |" >> $GITHUB_STEP_SUMMARY
        echo "| â­ï¸ Skipped | **$SKIPPED** |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ Total | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$FAILED" = "0" ] || [ -z "$FAILED" ]; then
          echo "âœ… **All unit tests passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **$FAILED test(s) failed**" >> $GITHUB_STEP_SUMMARY
        fi
